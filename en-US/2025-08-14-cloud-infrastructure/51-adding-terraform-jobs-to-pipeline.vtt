WEBVTT

1
00:00:00.160 --> 00:00:02.560
&gt;&gt; Erik Reinert: We need to run
the database migrations, right?

2
00:00:02.560 --> 00:00:06.480
Now what we need to do is we need to
get back to the CI, CD part of things.

3
00:00:06.480 --> 00:00:11.040
We've run everything we really need to
from an infrastructure perspective, right?

4
00:00:12.160 --> 00:00:15.440
And we've even set up the database
credentials and all that kinda stuff.

5
00:00:15.440 --> 00:00:19.435
But there's actually two
things we haven't done,

6
00:00:19.435 --> 00:00:22.898
which is we haven't, again, set up the CI.

7
00:00:22.898 --> 00:00:27.869
But we also need to make sure that
we update the Google Cloud URL,

8
00:00:27.869 --> 00:00:31.750
right, in the credentials
to the new URL as well.

9
00:00:31.750 --> 00:00:35.361
Because if we're using those credentials
in a new environment with a new URL,

10
00:00:35.361 --> 00:00:37.110
it'll be broken, right?

11
00:00:37.110 --> 00:00:42.128
So what we'll have to do is
go to our distribution or

12
00:00:42.128 --> 00:00:45.629
our CloudFront, go here, right,

13
00:00:45.629 --> 00:00:52.420
copy this distribution name,
then go to CloudConsole, right?

14
00:00:52.420 --> 00:00:55.836
Go to Console, go in here,

15
00:00:55.836 --> 00:01:01.340
go to Credentials, and then click on this.

16
00:01:01.340 --> 00:01:05.076
Now, I'm not gonna click it because
yesterday I realized when I click it,

17
00:01:05.076 --> 00:01:08.811
it docks the secret and the key, which
is why I had to delete them so quick and

18
00:01:08.811 --> 00:01:09.660
I ran over here.

19
00:01:09.660 --> 00:01:14.128
So I'm not gonna click it, but again,
this is the part where you go click, add

20
00:01:14.128 --> 00:01:18.831
the redirect URI for the new environment,
save it, and then it'll be good to go.

21
00:01:18.831 --> 00:01:21.753
&gt;&gt; Male Speaker 1: It's only
needed to actually log in, right?

22
00:01:21.753 --> 00:01:23.146
&gt;&gt; Erik Reinert: Yes.
&gt;&gt; Male Speaker 1: It's not needed for

23
00:01:23.146 --> 00:01:24.060
the front page?

24
00:01:24.060 --> 00:01:24.750
&gt;&gt; Erik Reinert: No, it's not.

25
00:01:24.750 --> 00:01:25.510
Yeah, exactly.

26
00:01:25.510 --> 00:01:28.306
So in this case,
it's totally fine if it's broken.

27
00:01:28.306 --> 00:01:32.718
For our use case, yeah,
it's gonna be fine that it's broken.

28
00:01:32.718 --> 00:01:34.379
[LAUGH] Just to save time, yeah,

29
00:01:34.379 --> 00:01:37.588
we're not gonna go too deep
into troubleshooting and stuff.

30
00:01:37.588 --> 00:01:41.830
But I went ahead and
added it since I was right there anyway.

31
00:01:41.830 --> 00:01:42.790
Okay, cool.

32
00:01:42.790 --> 00:01:45.710
So that was the first
thing we needed to do.

33
00:01:45.710 --> 00:01:49.890
The next thing we need to do is we need
to add some automation for some stuff.

34
00:01:49.890 --> 00:01:53.715
Cool.
So I'm gonna do git commit -m

35
00:01:53.715 --> 00:01:58.930
feature added service automation.

36
00:01:58.930 --> 00:02:02.066
I went ahead and pushed that up just to
kinda give myself a little bit of a clean

37
00:02:02.066 --> 00:02:04.450
environment for what we're gonna do next.

38
00:02:04.450 --> 00:02:08.974
And so what I wanna do next is I
actually want to create an entire new

39
00:02:08.974 --> 00:02:12.530
file inside of
the github/workflows directory.

40
00:02:12.530 --> 00:02:16.610
Now the reason why I'm going to do that is
because we want to run more automation.

41
00:02:16.610 --> 00:02:19.938
What automation do you
think we want to run?

42
00:02:19.938 --> 00:02:21.090
&gt;&gt; Male Speaker 1: Migrations.

43
00:02:21.090 --> 00:02:22.210
&gt;&gt; Erik Reinert: Not just migrations.

44
00:02:22.210 --> 00:02:23.810
No, not just that.

45
00:02:23.810 --> 00:02:27.490
It's not related to the service per se.

46
00:02:27.490 --> 00:02:28.490
&gt;&gt; Male Speaker 1: The Terraform thing?

47
00:02:28.490 --> 00:02:29.930
&gt;&gt; Erik Reinert: The Terraform,
yeah, exactly.

48
00:02:29.930 --> 00:02:31.210
We want to run the Terraform.

49
00:02:31.210 --> 00:02:35.010
So we want Terraform and
our deployments to go out, right?

50
00:02:35.010 --> 00:02:38.050
We want everything to go
out of this repository.

51
00:02:38.050 --> 00:02:43.001
So what we want to do is we want to
add all of the pipeline jobs and

52
00:02:43.001 --> 00:02:46.390
everything for running Terraform.

53
00:02:46.390 --> 00:02:50.310
Now, I'm not going to go into super
detail on this, but to explain it.

54
00:02:50.310 --> 00:02:54.390
And again, you're really seeing a lot
of repeated things here, right?

55
00:02:54.390 --> 00:02:57.379
You're seeing the concurrency thing
that we talked about earlier so

56
00:02:57.379 --> 00:03:01.350
that deployments don't block, or so
deployments block each other, right?

57
00:03:01.350 --> 00:03:04.870
You're seeing the runs on ubuntu-latest,
right?

58
00:03:04.870 --> 00:03:08.109
The only thing that's new is
we're setting up Terraform and

59
00:03:08.109 --> 00:03:10.550
we're running Terraform commands.

60
00:03:10.550 --> 00:03:11.830
So that's really it.

61
00:03:11.830 --> 00:03:14.190
We're setting up Terraform and
running Terraform commands.

62
00:03:14.190 --> 00:03:17.590
So we do a check to make sure
that we have formatting.

63
00:03:17.590 --> 00:03:20.790
Everything's formatted properly and
validated, right?

64
00:03:20.790 --> 00:03:25.510
And then we run plan,
which just does init and plan, right?

65
00:03:25.510 --> 00:03:27.550
Note the upload-artifacts.

66
00:03:27.550 --> 00:03:30.672
So remember earlier how I told you
you can like take a TF plan and

67
00:03:30.672 --> 00:03:34.830
then like upload it somewhere and then use
it in a different job or somewhere else?

68
00:03:34.830 --> 00:03:36.630
That's exactly what we're doing here.

69
00:03:36.630 --> 00:03:41.910
And then we do on Apply if refs/head/main,
so we only apply on main, right?

70
00:03:43.010 --> 00:03:46.177
Even though the service
deploys on both staging and

71
00:03:46.177 --> 00:03:50.930
production, the Terraform will only
ever need to be ran once on Main.

72
00:03:50.930 --> 00:03:57.330
So we don't need to let that run on
any other branch for Apply than Main.

73
00:03:57.330 --> 00:03:58.650
So that's exactly what we do.

74
00:03:58.650 --> 00:04:02.887
We then check out the code,
download the artifact, and

75
00:04:02.887 --> 00:04:08.440
then run the TF plan, Apply or
Terraform Apply with the TF plan file.

76
00:04:08.440 --> 00:04:09.480
And boom, there we go.

77
00:04:09.480 --> 00:04:12.360
We are all set again.

78
00:04:12.360 --> 00:04:13.440
It's a pretty big file.

79
00:04:13.440 --> 00:04:16.200
Just to save time,
I'm going to go quickly through that.

80
00:04:16.200 --> 00:04:17.702
But if you want to see more of it,

81
00:04:17.702 --> 00:04:21.400
feel free to go through the file
itself in the repository.

82
00:04:21.400 --> 00:04:27.494
But the end effect should
be feature added Terraform

83
00:04:27.494 --> 00:04:33.320
jobs is if I push this up and
then I go to our branch.

84
00:04:34.930 --> 00:04:36.220
Now I'm actually going
to go to our branch.

85
00:04:41.090 --> 00:04:44.530
&gt;&gt; Erik Reinert: We will see a whole
new job running called Terraform.

86
00:04:45.810 --> 00:04:48.850
You can see now it's actually
initializing the Terraform.

87
00:04:48.850 --> 00:04:52.170
Remember, we already have
AWS credentials in GitHub.

88
00:04:52.170 --> 00:04:53.730
We did that yesterday.

89
00:04:53.730 --> 00:04:58.210
So this goes back to that whole
dogfooding what we've already created and

90
00:04:58.210 --> 00:05:02.610
making it so that we can just
reuse things we've already done.

91
00:05:02.610 --> 00:05:06.682
In this case, we've already added
the credentials to connect to Amazon and

92
00:05:06.682 --> 00:05:09.810
all that stuff so
we could just reuse it for the terraform.

93
00:05:09.810 --> 00:05:13.242
And because the credentials are or
allow everything,

94
00:05:13.242 --> 00:05:18.249
we don't really have to worry about
permissions or anything like that either.

95
00:05:18.249 --> 00:05:20.610
It'll do everything we need.

96
00:05:20.610 --> 00:05:25.509
But now we are shipping code and
building and testing code in one workflow,

97
00:05:25.509 --> 00:05:29.943
and then in another workflow we
are running the exact same terraform

98
00:05:29.943 --> 00:05:32.450
commands that you saw me run locally.

99
00:05:33.640 --> 00:05:34.600
There we go.

100
00:05:34.600 --> 00:05:36.840
You'll see that apply skips.

101
00:05:36.840 --> 00:05:42.800
You already understand how we do the don't
and do run jobs and stuff like that.

102
00:05:42.800 --> 00:05:44.920
I don't think I need to
go super deep into that.

103
00:05:44.920 --> 00:05:47.845
You just need to know that
the apply job was skipped and

104
00:05:47.845 --> 00:05:49.800
it did it because we expected it to.

105
00:05:51.000 --> 00:05:52.280
Cool.
Awesome.

106
00:05:52.280 --> 00:05:54.660
Again, you'll note that
even though that ran,

107
00:05:54.660 --> 00:05:56.840
we still are running our build and deploy.

108
00:05:56.840 --> 00:05:59.720
It's going through the actual process
of building our image and everything.

