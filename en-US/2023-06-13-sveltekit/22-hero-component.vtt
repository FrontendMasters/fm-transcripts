WEBVTT

1
00:00:00.259 --> 00:00:04.748
So with use:enhance we can go further
than just emulating the browser's native

2
00:00:04.748 --> 00:00:05.414
behavior.

3
00:00:05.414 --> 00:00:08.143
We can provide a callback to the action,

4
00:00:08.143 --> 00:00:12.086
which adds things like pending states and
optimistic UI.

5
00:00:12.086 --> 00:00:16.370
So to be able to see this, we're gonna add
an artificial delay to our two actions.

6
00:00:16.370 --> 00:00:18.939
Open up your page server.js file.

7
00:00:18.939 --> 00:00:25.250
And in the Create Action,
we'll do await new Promise and

8
00:00:25.250 --> 00:00:30.260
we'll set timeout on that fulfil callback.

9
00:00:32.580 --> 00:00:36.781
We'll give it a delay
of 1000 milliseconds.

10
00:00:36.781 --> 00:00:40.141
I'm gonna copy that and
add the same thing in the delete action.

11
00:00:42.401 --> 00:00:50.941
All right, so now if we,
Buy some milk, I don't know.

12
00:00:50.941 --> 00:00:53.703
We'll see that nothing happens for
a second, and

13
00:00:53.703 --> 00:00:55.623
then the todo is added to the list.

14
00:00:55.623 --> 00:01:00.052
Obviously not a very satisfying experience
if the user has to wait a whole

15
00:01:00.052 --> 00:01:03.186
second before they see
their updates take effect.

16
00:01:03.186 --> 00:01:08.365
So let's add some local state so
we can add some optimistic UI.

17
00:01:08.365 --> 00:01:12.245
Up in our script tag on
the page.svelte file,

18
00:01:12.245 --> 00:01:18.327
we're gonna create a creating
variable that's initialized to false.

19
00:01:18.327 --> 00:01:23.337
And we'll have an array of the todos
that are currently being deleted.

20
00:01:30.307 --> 00:01:32.467
We'll go to the first form,
where we add a todo.

21
00:01:35.107 --> 00:01:37.879
And I'm just gonna restructure
this a little bit so

22
00:01:37.879 --> 00:01:39.948
that the code becomes easier to read.

23
00:01:39.948 --> 00:01:42.246
Put all of the attributes
on separate lines.

24
00:01:45.060 --> 00:01:47.150
I'm gonna provide
a callback to use:enhance.

25
00:01:51.190 --> 00:01:54.512
First thing we're gonna do
is set creating to true.

26
00:01:57.550 --> 00:01:59.930
And then we're gonna return
an asynchronous function,

27
00:02:02.730 --> 00:02:05.131
That takes this update utility.

28
00:02:07.911 --> 00:02:12.802
We're gonna call that, and all that is
gonna do is whatever would have happened

29
00:02:12.802 --> 00:02:14.781
had we not provided a callback.

30
00:02:14.781 --> 00:02:19.431
Once the update is complete,
we'll set creating back to false.

31
00:02:22.711 --> 00:02:28.271
And then we're gonna disable the input
while the todo is being created.

32
00:02:30.791 --> 00:02:35.251
Just add that disable attribute
when creating is true.

33
00:02:38.651 --> 00:02:41.531
And we can now show a message
while we are saving data.

34
00:02:41.531 --> 00:02:44.912
Underneath the list of todos,
we're gonna add an f block.

35
00:02:44.912 --> 00:02:47.572
If creating is true,

36
00:02:51.472 --> 00:02:56.499
Then we'll add a span there,
with a class of saving,

37
00:02:56.499 --> 00:03:01.426
and we'll just say saving...,
close the span.

38
00:03:06.213 --> 00:03:08.113
And then now if you add another todo,

39
00:03:13.676 --> 00:03:17.846
We get some user interface that tells
the user that their action has been

40
00:03:17.846 --> 00:03:22.029
acknowledged, and that we're just
waiting for something to happen.

41
00:03:22.029 --> 00:03:26.477
In the case of deletions, we don't
really need to wait for the server to

42
00:03:26.477 --> 00:03:31.093
validate anything, we can just update
the user interface immediately.

43
00:03:31.093 --> 00:03:38.099
So inside the each block where we're
iterating over the list of todos,

44
00:03:38.099 --> 00:03:43.133
the first thing we're gonna
do is filter the list.

45
00:03:43.133 --> 00:03:45.279
Instead of just showing all of the todos,

46
00:03:45.279 --> 00:03:48.787
we're gonna show all of the todos
that are not marked for deletion.

47
00:03:48.787 --> 00:03:53.387
And we can do that by adding
this line inside each block.

48
00:03:53.387 --> 00:03:56.367
Each data todos.filter.

49
00:03:59.472 --> 00:04:06.080
And then the callback is gonna
be that the deleting array

50
00:04:06.080 --> 00:04:11.293
does not include the ID
of the current todo.

51
00:04:14.154 --> 00:04:19.022
Right now that's having no effect
because none of our todos are currently

52
00:04:19.022 --> 00:04:20.132
being deleted.

53
00:04:20.132 --> 00:04:23.849
But we can change that by again adding
a call back to the use:enhance action.

54
00:04:23.849 --> 00:04:28.329
Split the attributes onto multiple
lines to make it easier to read.

55
00:04:35.469 --> 00:04:38.189
And the first thing we'll do
is update the deleting array,

56
00:04:44.349 --> 00:04:46.209
To include the todo that's being deleted.

57
00:04:46.209 --> 00:04:49.449
And then we'll return
the completion handler,

58
00:04:56.070 --> 00:04:59.050
That again is gonna cause
the update function,

59
00:05:02.344 --> 00:05:06.237
That applies the changes that
were gonna happen anyway, and

60
00:05:06.237 --> 00:05:09.149
then removes that ID
from the deleted array.

61
00:05:24.340 --> 00:05:26.760
Okay, that was a lot of code,
hopefully we typed it correctly.

62
00:05:29.860 --> 00:05:33.083
So now even though it's
gonna take a second for

63
00:05:33.083 --> 00:05:38.798
the action to actually take place, I can
delete these todos in quick succession.

64
00:05:38.798 --> 00:05:43.252
I forgot to add the CSS on this exercise,
so just pretend that you can

65
00:05:43.252 --> 00:05:47.101
see the trash can icon on
the right-hand side of the todo.

66
00:05:47.101 --> 00:05:50.284
As we click these, the todos get deleted,

67
00:05:50.284 --> 00:05:55.686
even though we're waiting for
the server to actually apply the action.

68
00:05:55.686 --> 00:05:59.727
And so use:enhance is very customizable,
you can cancel submissions,

69
00:05:59.727 --> 00:06:04.309
you can handle redirects, you can control
whether the form is reset, all of that.

70
00:06:04.309 --> 00:06:07.589
You can see the reference documentation
for all the details on how to do that.

